{%extends display.admin%}


{%block pageContent%}


<div class="f">
  <div class="c9 s12 pRa10">
    {{block("iChatList")}}
    {%include 'content_support/ticket/addForm.html'%}

  </div>
  <div class="c3 s12">
{%if perm('supportTicketView') %}
    <div class="cbox">
{%if masterTicketDetail.status == 'awaiting' or masterTicketDetail.status == 'answered'%}
      <div class="fs08">
        <p>{%trans "If your problem is solved or do not need to track, please close this ticket by press below bottom."%} {%trans "You can open it anytime you need."%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block mTB10 secondary" name="status" value="close">{%trans "Close ticket"%}</button>
      </form>
{%elseif masterTicketDetail.status == 'close'%}
      <div class="fs08">
        <p>{%trans "This ticket is closed."%} {%trans "You can open it anytime you need."%} {%trans "Also you can delete it if you do not need it."%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block sm mTB10 danger outline" name="status" value="delete">{%trans "Delete ticket"%}</button>
        <button class="btn block lg mTB10 success" name="status" value="open">{%trans "Open it again"%}</button>
      </form>
{%elseif masterTicketDetail.status == 'deleted'%}
      <div class="fs08">
        <p>{%trans "This is deleted ticket."%} {%trans "You can change it to close condition if need to save it in history!"%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block mTB10 secondary" name="status" value="close">{%trans "Close ticket"%}</button>
      </form>
{%endif%}
    </div>
{%endif%}

{%if perm('supportTicketView') %}
    <div class="cbox">
<!-- do some admin actions -->

      <label for="creator">{%trans "Creator"%}</label>
      <div class="input">
        <input type="text" id="creator" disabled value="{{masterTicketDetail.author}}">
      </div>

      <label for="email">{%trans "Email"%}</label>
      <div class="input">
        <input type="text" id="email" disabled value="{{masterTicketDetail.email}}">
      </div>

      <label for="mobile">{%trans "Mobile"%}</label>
      <div class="input">
        <input type="text" id="mobile" disabled value="{{masterTicketDetail.mobile | fitNumber('mobile')}}">
      </div>

      <form method="post">
        {{block("iTag")}}
        <button class="btn block mTB10 primary"  name="TicketFormType" value="tag">{%trans "Save tag"%}</button>
      </form>
    </div>
{%endif%}

  </div>
</div>
{%endblock%}




{%block iChatList%}
{%set myStatus = masterTicketDetail.status%}
<div class="cbox" title='{%trans "Status"%} <b>{%trans myStatus%}</b>'>
  <div class="msg pain special fs10 f">
    <div class="cauto pRa10"><span class="badge rounded" title='{%trans "Ticket No"%}'>{{masterTicketDetail.id | fitNumber}}</span></div>
    <div>{{masterTicketDetail.title}}</div>
    <div class="cauto os fs08 compact" title='{%trans "Last activity"%} {{dataTable.0.datecreated | tdate("l d F Y H:i:s")}}'>{{masterTicketDetail.datecreated | tdate("l d F Y H:i:s")}}</div>
  </div>

  <table class="tbl1 v5">
    <tbody>
{%for key, value in dataTable%}
      <tr class="{{value.rowColor}}" id='msg{{value.id}}'>
        <td class="collapsing">
          <img src="{{value.avatar}}" class="avatar mRa10" alt="{{value.displayname}}">
          <span class="txtB s0 fs08">{{value.displayname}}</span>
{%if perm_su()%}
          <nav class="txtRa">
            <a href="{{url.this}}?user_id={{value.user_id}}" title='{%trans "User tickets"%}'><i class="sf-question-circle"></i></a>
            <a href="{{url.kingdom}}/cp/users/view?id={{value.user_id}}" title='{%trans "User Profile"%}'><i class="sf-user-md"></i></a>
            <a href="{{url.kingdom}}/cp/visitor/user?id={{value.user_id}}" title='{%trans "User last visits"%}'><i class="sf-flight"></i></a>
            <a href="{{url.kingdom}}/cp/visitor/before?id={{value.user_id}}&datetime={{masterTicketDetail.datecreated | url_encode}}" title='{%trans "Before create ticket"%}'><i class="sf-dzone"></i></a>
          </nav>
{%endif%}
        </td>
        <td class="pRa10">{{value.content | raw | nl2br}}</td>
        <td class="collapsing"><small class="fc-mute" title='{{value.datecreated | tdate("l d F Y H:i:s")}}'>{{value.datecreated | sdate("year")}}</small></td>
      </tr>
{%endfor%}
    </tbody>
  </table>
</div>
{%endblock%}




{%block iTag%}
<div class="tagDetector">
  {%set myID = requestGET.id | coding('encode')%}
{%set postTag = tags({"post_id" : myID , "title" : true, "format" : 'csv', "type" : "support_tag", "related" : "comments"}) %}


  <div class="input mB10 hide">
    <input type="text" class="input tagVals" name="tag" value="{{postTag}}" id="tagValues" placeholder='{%trans "Tag"%}'>
  </div>

  <div class="input" title='{%trans "Add tag manually to link tickets togethers"%}'>
    <input type="text" class="tagInput" placeholder='{%trans "Tag keywords..."%}'>
    <button class="addon tagAdd">+</button>
  </div>
  <div class="tagBox"></div>
</div>
{%endblock%}