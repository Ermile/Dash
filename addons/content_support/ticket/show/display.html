{%extends display.admin%}


{%block pageContent%}


<div class="f">
  <div class="c8 s12 pRa10">
    {{block("iChatList")}}
    {%include 'content_support/ticket/addForm.html'%}

  </div>
  <div class="c4 s12">
{%if true %}
    <div class="cbox">
{%if masterTicketDetail.status == 'awaiting' or masterTicketDetail.status == 'answered'%}
      <div class="fs08">
        <p>{%trans "If your problem is solved or do not need to track, please close this ticket by press below bottom."%} {%trans "You can open it anytime you need."%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block mTB10 secondary" name="status" value="close">{%trans "Close ticket"%}</button>
      </form>
{%elseif masterTicketDetail.status == 'close'%}
      <div class="fs08">
        <p>{%trans "This ticket is closed."%} {%trans "You can open it anytime you need."%} {%trans "Also you can delete it if you do not need it."%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block sm mTB10 danger outline" name="status" value="deleted">{%trans "Delete ticket"%}</button>
        <button class="btn block lg mTB10 success" name="status" value="awaiting">{%trans "Open it again"%}</button>
      </form>
{%elseif masterTicketDetail.status == 'deleted'%}
      <div class="fs08">
        <p>{%trans "This is deleted ticket."%} {%trans "You can change it to close condition if need to save it in history!"%}</p>
      </div>
      <form method="post">
        <input type="hidden" name="TicketFormType" value="changeStatus">
        <button class="btn block mTB10 secondary" name="status" value="close">{%trans "Close ticket"%}</button>
      </form>
{%endif%}
    </div>
{%endif%}

{%if perm('supportTicketView') %}
    <div class="cbox">
      <form method="post">
        {{block("iTag")}}
        <button class="btn block mTB10 primary"  name="TicketFormType" value="tag">{%trans "Save tag"%}</button>
      </form>
    </div>
{%endif%}

{%if perm_su()%}
{%if lastSeen%}
  <div class="cbox">
    {%for key, value in lastSeen%}
    {%set nowDate = "now" | date("Y-m-d")%}
    {%if value.date == nowDate%}
      {%set myClass = 'success2'%}
    {%endif%}
    <div class="msg {{myClass}}">{{value.timeraw | date("Y-m-d H:i:s") |  tdate("l d F Y H:i:s")}}</div>
    {%endfor%}
  </div>
{%endif%}
  </div>
{%endif%}
</div>
{%endblock%}




{%block iChatList%}
{%set myStatus = masterTicketDetail.status%}
<div class="cbox">
  <div class="msg {%if masterTicketDetail.colorClass%}{{masterTicketDetail.colorClass}}{%else%}pain{%endif%} special fs10 f" title='{%trans "Status"%} <b>{%trans myStatus%}</b>'>
    <div class="cauto pRa10"><span class="badge rounded" title='{%trans "Ticket No"%}'>{{masterTicketDetail.id | fitNumber}}</span></div>
    <div>{{masterTicketDetail.title}}</div>
    <div class="cauto os fs08 compact" title='{%trans "Last activity"%} {{dataTable.0.datecreated | tdate("l d F Y H:i:s")}}'>{{masterTicketDetail.datecreated | tdate("l d F Y H:i:s")}}</div>
  </div>

{%set myID = requestGET.id | coding('encode')%}
{%set myTag = tags({"post_id" : myID ,  "format" : 'array', "type" : "support_tag", "related" : "comments"}) %}
{%if myTag%}
  <div class="tagBox">
  {%for key, value in myTag%}
    {%if value.status == 'enable' or perm_su()%}
      <a class="btn rounded sm mB5 {%if value.meta.color%}{{value.meta.color}}{%endif%}" href="{{url.this}}?tag={{value.slug}}">{{value.title}}</a>
    {%endif%}
  {%endfor%}
  </div>
{%endif%}


  <table class="tbl1 v5">
    <tbody>
{%for key, value in dataTable%}
      <tr class="{{value.rowColor}}" id='msg{{value.id}}'>
        <td class="collapsing">
          <img src="{{value.avatar}}" class="avatar mRa10" alt="{{value.displayname}}">
          <span class="txtB s0 fs08">{{value.displayname}}</span>
{%if perm_su()%}
          <div class="txtRa fs08">{{masterTicketDetail.mobile | fitNumber('mobile12')}}</div>
          <nav class="txtRa">
            <a href="{{url.this}}?user_id={{value.user_id}}" title='{%trans "User tickets"%}'><i class="sf-question-circle"></i></a>
            <a href="{{url.kingdom}}/cp/users/view?id={{value.user_id}}" title='{%trans "User Profile"%}'><i class="sf-user-md"></i></a>
            <a href="{{url.kingdom}}/cp/visitor?userid={{value.user_id}}" title='{%trans "User last visits"%}'><i class="sf-flight"></i></a>
            <a href="{{url.kingdom}}/cp/visitor?type=before&userid={{value.user_id}}&datetime={{masterTicketDetail.datecreated | url_encode}}" title='{%trans "Before create ticket"%}'><i class="sf-dzone"></i></a>
          </nav>
{%endif%}
        </td>
        <td class="pRa10">
          <div>{{value.content | raw | nl2br}}</div>
          <div class="f mT10">
{%if value.file %}
           <div>
            <a class="badge" href="{{value.file}}" target="_blank">{%trans "View attachment"%}</a>
           </div>
{%endif%}
           <div class="cauto os fc-mute">
            <small title='{{value.datecreated | tdate("l d F Y H:i:s")}}'>{{value.datecreated | sdate("year")}}</small>
{%if perm_su()%}
            <a class="fs08 mLa10" href="{{url.here}}/message/edit?id={{value.id}}">{%trans "Edit"%}</a>
{%endif%}
           </div>
          </div>
        </td>
      </tr>
{%endfor%}
    </tbody>
  </table>
</div>
{%endblock%}





{%block iTag%}
 <select class="ui multiple search selection dropdown addition" multiple>
      <option value="">{%trans "Tag keywords..."%}</option>
      {%for key, value in tagList%}
        <option value="{{value.title}}">{{value.title}}</option>
      {%endfor%}
    </select>
{%if false%}
<div class="tagDetector">

{%set myID = requestGET.id | coding('encode')%}
{%set postTag = tags({"post_id" : myID , "title" : true, "format" : 'csv', "type" : "support_tag", "related" : "comments"}) %}


  <div class="input mB10 hide">
    <input type="text" class="input tagVals" name="tag" value="{{postTag}}" id="tagValues" placeholder='{%trans "Tag"%}'>
  </div>

  <div class="input" title='{%trans "Add tag manually to link tickets togethers"%}'>
    <input type="text" class="tagInput" placeholder='{%trans "Tag keywords..."%}'>
    <button class="addon tagAdd">+</button>
  </div>
  <div class="tagBox"></div>
</div>
{%endif%}
{%endblock%}